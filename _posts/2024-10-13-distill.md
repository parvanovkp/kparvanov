---
layout: distill
title: Detecting Regime Shifts in SP500 Stocks Using PCA and Sparse PCA
description: This project explores PCA and Sparse PCA on 457 SP500 stocks, using 2-minute interval data over 31 trading days (August 8 to September 19, 2024). The focus is on experimenting with dimensionality reduction techniques to identify regime shifts and key factors driving stock returns.
tags: ["pca", "sparse pca", "dimensionality reduction", "financial analysis", "regime shift"]
categories: ["machine learning", "finance", "data analysis"]
giscus_comments: false
date: 2024-10-13
featured: false
published: true
thumbnail: assets/img/RegimeShift/Regime_Shift_Thumbnail.png
tabs: true

authors:
  - name: Kaloyan Parvanov
    url: "https://kparvanov.com"
    affiliations:
      name: Independent Project

toc:
  - name: "Introduction: Dimensionality Reduction and Financial Data Analysis"
  - name: "Data Preparation"
    subsections:
      - name: "Data Verification and Consistency"
      - name: "Data Cleaning and Preprocessing"
  - name: "Principal Component Analysis (PCA)"
    subsections:
      - name: "Full Period PCA"
      - name: "Sparse PCA"
      - name: "Sector-Based PCA Analysis"
        subsections:
          - name: "Interpretation of Sector-based PCA Analysis Results"
  - name: "Correlation with ETF Factors"
    subsections:
      - name: "Methodology"
      - name: "Results"
        subsections:
          - name: "Correlation Heatmaps"
          - name: "Lag Analysis"
      - name: "Interpretation"
      - name: "Implications"
      - name: "Conclusion and Transition to Dynamic Analysis"
  - name: "Rolling Window PCA"
    subsections:
      - name: "Methodology"
      - name: "Stability and Deviation Metrics"
      - name: "Interactive Dashboard"
      - name: "Results and Interpretation"
        subsections:
          - name: "Rolling Window PCA and Sparse PCA"
          - name: "Market Stability Analysis"
          - name: "Deviation from Full Period Analysis"
      - name: "Implications and Insights"
  - name: "Intraday Pattern Analysis"
    subsections:
      - name: "Methodology"
      - name: "Results and Interpretation"
        subsections:
          - name: "Intraday Patterns Heatmap"
          - name: "Sector Influence Changes"
      - name: "Key Intraday Patterns Observed"
      - name: "Implications"
      - name: "Limitations and Future Work"
  - name: "Conclusion: Key Findings and Future Research Directions"
  - name: "Appendix"
---

## Introduction: Dimensionality Reduction and Financial Data Analysis

This project applies Principal Component Analysis (PCA) and Sparse PCA to analyze the S&P 500 stock market. By leveraging these dimensionality reduction techniques on high-frequency trading data, the aim is to uncover hidden structures, identify regime shifts, and understand key factors driving stock returns.

PCA is crucial in financial data analysis as it can reduce the dimensionality of large datasets while preserving essential information. This allows for the identification of primary factors influencing market behavior, valuable for risk management and portfolio optimization.

The dataset initially comprised all 503 stocks from the S&P 500 index, sampled at 2-minute intervals over 31 trading days from August 8 to September 19, 2024, using the Yahoo Finance API. This high-frequency data captures intraday patterns and short-term market dynamics often missed in lower frequency data.

Through standard PCA and Sparse PCA, the project aims to identify the main components driving market variance and enhance their interpretability. Sparse PCA particularly helps pinpoint key stocks most influential in each component.

The analysis explores sector-specific patterns, correlations with major ETF factors, and the evolution of market regimes over time, offering potentially valuable insights for both academic research and industry practice in quantitative finance. Finally, the project is also an opportunity for me to practice and demonstrate my skills in the field of Machine Learning.

## Data Preparation

### Data Verification and Consistency

The initial dataset included all 503 S&P 500 stocks and 20 ETFs, covering the period from August 8 to September 19, 2024. This data was sampled at 2-minute intervals using the Yahoo Finance API, resulting in 31 trading days of high-frequency data.

To ensure data consistency, I focused on standard market hours, specifically 9:30 AM to 4:00 PM EST. This approach eliminates potential discrepancies or anomalies that might occur in pre-market or after-hours trading, providing a more reliable basis for analysis.

### Data Cleaning and Preprocessing

The data cleaning process involved several critical steps:

1. **Handling Missing Data**: I implemented a forward+backward-filling strategy with a limit of 5 intervals to address short gaps in the data. This approach preserves the temporal structure of the data while avoiding the introduction of artificial patterns.

2. **Asset Filtering**: To maintain data quality, I removed assets with excessive missing data. Specifically, any asset with more than 20% missing data was excluded from the analysis. This resulted in the retention of 457 stocks out of the initial 503, as some stocks lacked sufficient data from the Yahoo Finance API.

3. **Timestamp Synchronization**: All stock data was aligned to a common time index, ensuring that price movements are compared at precisely the same moments across the entire dataset.

4. **Return Calculation**: Instead of working with raw price data, I calculated logarithmic returns. Log returns are preferred in financial analysis as they are additive over time and provide a more accurate representation of percentage changes, especially for high-frequency data.

5. **Standardization**: To ensure comparability across stocks with different price levels and volatilities, I standardized the returns. This process involves subtracting the mean and dividing by the standard deviation for each stock's return series, resulting in a dataset where each stock has a mean of 0 and a standard deviation of 1.

The preprocessing yielded a final dataset of 5,463 valid time points for 457 stocks and 20 ETFs, retaining 96.6% of the combined stock data. This high retention rate ensures data quality while accommodating necessary exclusions due to insufficient data. The resulting cleaned and standardized dataset of log-normalized returns provides a good foundation for PCA and Sparse PCA analyses, allowing for the identification of genuine market patterns and relationships.

## Principal Component Analysis (PCA)

Principal Component Analysis (PCA) is a dimensionality reduction technique widely used in financial data analysis. It transforms the original dataset into a new coordinate system where the axes (principal components) are ordered by the amount of variance they explain in the data. This section explores three applications of PCA to my dataset of S&P 500 stock returns: Full Period PCA, Sparse PCA, and Sector-based PCA analysis.

### Full Period PCA

I applied Full Period PCA to the entire dataset, covering all 457 stocks over the 31-day trading period. Mathematically, PCA seeks to find a set of orthogonal vectors (principal components) that maximize the variance of the projected data.

For a data matrix $X$, PCA solves the eigenvalue problem:

$$(X^TX)v_i = \lambda_i v_i$$

where $v_i$ are the eigenvectors (principal components) and $\lambda_i$ are the corresponding eigenvalues, which represent the amount of variance explained by each component.

Note that the components are usually arranged in decreasing order based on the explained variance they have. Thus, PC1 would have the most explained variance, PC2 would have the second most explained variance, etc.

Finally, I performed the analysis using sklearn's PCA implementation, with the number of components determined by the cumulative explained variance ratio. This approach allowed me to identify the key drivers of variance in the stock market during the studied period.

#### Interpretation of Full Period PCA Results

The first plot generated from the PCA on the full trading period was the cumulative explained variance plot, which is crucial for understanding how many principal components are needed to explain a given percentage of the variance in the data. I observed that capturing 80% of the variance requires 154 components, while 90% requires 255 components—slightly more than half of the total 457 components. This outcome is typical for financial time-series data, likely due to its heavy-tailed distribution. An additional noteworthy observation from the plot below is that the first principal component alone explains nearly 25% of the variance in the data. Traditionally, this component is strongly associated with broad market movement and may capture underlying general trends in stock prices. However, it’s important to recognize that principal components often represent a mix of various factors rather than having singular, clear-cut meanings. As such, a thorough analysis is necessary before attempting to interpret principal components as representing specific economic or market factors.

<div class="l-page">
  <iframe src="{{ '/assets/plotly/RegimeShift/full_period_pca_variance.html' | relative_url }}" frameborder='0' scrolling='no' height="500px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Cumulative explained variance plot. The plot shows that 154 components are needed to explain 80% of the variance, and 225 components are required to explain 90%. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/pca_results/full_period_pca_variance.html">Kal Parvanov/GitHub</a>
</div>

The second, and more intriguing, plot generated was a heatmap illustrating the relationship between the stocks in the dataset and the first 10 principal components. While the heatmap might initially seem overwhelming due to the large number of stocks, it reveals distinct clusters that are either positively or negatively associated with certain principal components. This observation led me to conclude that these stock clusters, likely representing individual sectors, could be significantly contributing to the principal components. If this is the case, it opens the possibility of assigning economic meaning to some components, potentially interpreting them as reflective of specific sectors of the economy. To investigate this further, I decided to apply sparse PCA, which is better suited to reducing noise and isolating the key drivers within each principal component.

<div class="l-page">
  <iframe src="{{ '/assets/plotly/RegimeShift/full_period_pca_heatmap.html' | relative_url }}" frameborder='0' scrolling='yes' height="500px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Heatmap of the contribution of individual stocks to each of the first 10 principal components. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/pca_results/full_period_pca_heatmap.html">Kal Parvanov/GitHub</a>
</div>

### Sparse PCA

While standard PCA provides valuable insights, its components often involve all input variables, making interpretation challenging. To address this limitation, I turned to Sparse PCA, which introduces sparsity in the principal components, effectively selecting a subset of the most influential stocks for each component.

Sparse PCA solves an optimization problem of the form:

$$\min_{U,V} \frac{1}{2}||X - UV^T||_F^2 + \alpha||V||_1$$

where $U$ are the sparse loadings, $V$ are the components, $\alpha$ is a sparsity parameter, and $\|\|\cdot\|\|_F$ denotes the Frobenius norm.

I applied Sparse PCA using sklearn's SparsePCA implementation, setting the number of components to 10. This approach enhances interpretability by identifying key stocks driving each component, allowing for more focused analysis of market dynamics.

The clusters observed in the heatmap during standard PCA suggested that specific groups of stocks, likely from the same sectors, contribute meaningfully to certain principal components. Sparse PCA's ability to highlight these key contributors while filtering out noise makes it an ideal tool for refining the sector-based analysis. By isolating the most influential stocks, Sparse PCA enhances the interpretability of the components and allows for a more focused exploration of sector-driven market dynamics.

Of course, as with all analytical tools, Sparse PCA has both benefits and drawbacks when it comes to its use in financial data analysis:

Benefits:

- **Improved Interpretability**: Unlike standard PCA, where all stocks contribute to each component, Sparse PCA isolates the key stocks driving each principal component. This allows for more intuitive interpretation, as the components are linked to a smaller group of stocks, potentially highlighting sector-specific dynamics or market themes.
- **Reduction of Noise**: By forcing many loadings to zero, Sparse PCA filters out less relevant stocks, reducing the noise and complexity in the interpretation of the components.
- **Sector-based Analysis**: Sparse PCA's ability to highlight key contributors makes it particularly useful for sector-based analysis. The identification of influential stocks within each component can provide insights into which sectors are driving market movements and how they relate to broader economic factors.

Drawbacks:

- **Loss of Information**: By focusing only on a subset of stocks, Sparse PCA may lose some of the finer details captured by the more comprehensive components of standard PCA. This can be a trade-off between interpretability and completeness.
- **Sensitivity to Parameter Tuning**: The sparsity of the solution depends on the choice of the $\alpha$ parameter, and selecting the right value is not always straightforward. A high $\alpha$ may oversimplify the model by excluding too many stocks, while a low $\alpha$ may not provide enough sparsity for meaningful interpretation.
- **Computational Complexity**: Sparse PCA can be more computationally intensive than standard PCA, especially when tuning parameters or working with large datasets.

Despite these drawbacks, I found Sparse PCA to be a powerful tool for uncovering the underlying structure of the S&P 500 stock returns, particularly in identifying sector-specific influences and key market drivers.

### Sector-Based PCA Analysis

To investigate sector-specific patterns in stock returns, I performed a sector-based analysis using the Sparse PCA results. I obtained the sector classification using the yfinance API, with stocks assigned to one of ten merged sector categories:

1. Technology
2. Healthcare
3. Consumer (Cyclical and Defensive)
4. Industrials
5. Financial Services
6. Energy
7. Communication Services
8. Real Estate
9. Utilities
10. Basic Materials

In this approach, I aggregated the Sparse PCA loadings for stocks within each sector, separating positive and negative loadings. This allowed me to visualize how different sectors contribute to each principal component, providing insights into sector-specific patterns and their influence on overall market movements.

#### Interpretation of Sector-based PCA Analysis Results

The Sparse PCA - Sector Loadings Heatmap provides a nuanced view of how different sectors contribute to each principal component, offering valuable insights into sector-specific patterns and their influence on overall market movements.

<div class="l-page">
  <iframe src="{{ '/assets/plotly/RegimeShift/sparse_pca_sector_heatmaps.html' | relative_url }}" frameborder='0' scrolling='yes' height="650px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Sector Loadings Heatmap: Sparse PCA Component Contributions Across Sectors. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/pca_results/sparse_pca_sector_heatmaps.html">Kal Parvanov/GitHub</a>
</div>

Analyzing the heatmap reveals several key observations:

**Sector-specific Contributions:**

| PC  | Positive Influence                  | Negative Influence                                             | Potential Interpretation                                         |
| --- | ----------------------------------- | -------------------------------------------------------------- | ---------------------------------------------------------------- |
| 1   | Industrials (36.6%)                 | Consumer (48%)                                                 | Production vs. consumption dynamic                               |
| 2   | Utilities (51.1%), Consumer (19.2%) | Technology (37.3%)                                             | Defensive sectors vs. growth-oriented tech                       |
| 3   | Energy (45.1%)                      | Consumer (35.5%), Technology (26.4%)                           | Traditional energy vs. tech-driven consumer trends               |
| 4   | Consumer (51.1%)                    | Technology (28%), Consumer (16.7%)                             | Intra-consumer dynamics and tech influence                       |
| 5   | Real Estate (50%)                   | Consumer (43.2%), Technology (18.1%)                           | Property market vs. consumer spending and tech                   |
| 7   | Financial Services (57.6%)          | Healthcare (21.8%), Technology (20.6%), Consumer (17.4%)       | Financial sector performance vs. healthcare and tech innovations |
| 9   | Technology (55%)                    | Financial Services (25.4%), Consumer (23.4%), Healthcare (20%) | Tech disruption vs. traditional finance and consumer sectors     |

**Dominant Sectors per Component (Rest of Components):**

| PC  | Positive Influence                    | Negative Influence                                               |
| --- | ------------------------------------- | ---------------------------------------------------------------- |
| 6   | Consumer (34.3%), Industrials (18.5%) | Healthcare (22.9%), Financials (20.8%)                           |
| 8   | Consumer (30.4%), Healthcare (28.2%)  | Industrials (22.3%), Technology (18.6%)                          |
| 10  | Healthcare (34.7%), Consumer (25.7%)  | Consumer (31.7%), Financial Services (17.1%), Technology (13.6%) |

1. **Unique Insights:**

   - Energy sector shows concentrated influence in PC3, suggesting impact specific to certain economic conditions.
   - Real Estate has strong positive influence in PC5 but minimal impact elsewhere, indicating isolated movements.
   - Technology consistently appears as a negative influence, suggesting its role as a disruptive force.

2. **Cross-Component Patterns:**

   - Consumer sector shows complex, varying influence across components, reflecting its multifaceted role in the economy.
   - Healthcare demonstrates diverse impact, with positive influence in later components (PC8, PC10) but negative in PC6.
   - Financial Services sector's loading pattern suggests sensitivity to specific economic factors like interest rates or regulatory changes.

3. **Sector Stability and Variability:**
   - Utilities show concentrated strong positive influence in PC2, potentially representing a stable, defensive factor.
   - Technology and Consumer sectors frequently appear across components, often in opposition, indicating their central role in market dynamics.

This sector-based analysis provides insights not easily discernible from individual stock analysis or full dataset PCA, highlighting how different economic sectors interact and contribute to overall market movements. The clear sector-specific patterns demonstrate the effectiveness of this approach in identifying key drivers of stock market returns.

The varying roles of sectors across components underscore the complexity of market dynamics and the importance of considering multiple factors in stock market analysis. This analysis reveals not just important sectors for each component, but also how they might work in opposition, providing a richer picture of the complex interplay between market segments.

It is important to note that these results are specific to the selected time window and may not generalize to other periods. Market dynamics can change over time, and the sector contributions observed here may differ under different economic conditions.

## Correlation with ETF Factors

To better understand the economic drivers behind the principal components identified through PCA and Sparse PCA, I conducted a correlation analysis with major ETF factors. This analysis helps to link the statistical components derived from my stock return data to broader market trends and investment styles, particularly in the context of the ongoing bull market, recent Federal Reserve actions, and global geopolitical events.

### Methodology

1. **Data Preparation**: I used the PCA and Sparse PCA component scores calculated from my stock return data, along with the returns of selected ETFs representing various investment factors (e.g., momentum, value, growth).

2. **Correlation Analysis**: I computed the Pearson correlation coefficients between each principal component (both from standard PCA and Sparse PCA) and the ETF returns.

3. **Visualization**: The correlations were visualized using heatmaps to provide an intuitive understanding of the relationships between components and ETF factors.

4. **Lag Analysis**: To identify potential leading or lagging relationships, I performed a lag analysis, calculating correlations at different time shifts between the components and ETF factors.

### Results

#### Correlation Heatmaps

<div class="l-body-outset">
  <iframe src="{{ '/assets/plotly/RegimeShift/pca_etf_correlation_heatmap.html' | relative_url }}" frameborder='0' scrolling='no' height="600px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Heatmap of correlations between PCA components and ETF factors. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/interpretation_results/pca_etf_correlation_heatmap.html">Kal Parvanov/GitHub</a>
</div>

<div class="l-body-outset">
  <iframe src="{{ '/assets/plotly/RegimeShift/sparse_pca_etf_correlation_heatmap.html' | relative_url }}" frameborder='0' scrolling='no' height="600px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Heatmap of correlations between Sparse PCA components and ETF factors. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/interpretation_results/sparse_pca_etf_correlation_heatmap.html">Kal Parvanov/GitHub</a>
</div>

#### Lag Analysis

I conducted a lag analysis to identify potential leading or lagging relationships between the PCA components and ETF factors. However, no significant lead-lag relationships were found. The most substantial lagged correlations were around 0.05, compared to non-lagged correlations of up to 0.90. For readers interested in the detailed results, the lag analysis plots are available [here](https://github.com/parvanovkp/RegimeShift/tree/main/interpretation_results).

### Interpretation

The correlation heatmaps reveal several interesting patterns and relationships between the PCA components and ETF factors. These should be interpreted in the context of the ongoing bull market since 2022, recent Federal Reserve actions, and significant global events:

1. **Full PCA Results:**

   | PC  | Strong Positive Correlations                                    | Strong Negative Correlations |
   | --- | --------------------------------------------------------------- | ---------------------------- |
   | PC1 | XLI (0.929), DIA (0.917), XLB (0.905), XLF (0.856), IWM (0.850) | VXX (-0.608)                 |

   - PC1 captures broad market movements across various sectors and cap sizes, reflecting the overall bullish trend despite global uncertainties.
   - The strong positive correlations with industrial (XLI) and materials (XLB) ETFs may reflect increased defense spending and the impact of sanctions on Russia, a major exporter of basic materials.
   - The positive correlation with financials (XLF) aligns with the high interest rate environment up to August 2024.
   - The negative correlation with VXX indicates lower market volatility, typical of a bull market, but also suggesting that geopolitical risks might be underpriced.
   - The remaining principal components show weaker correlations with the ETFs, potentially due to noise or more nuanced market dynamics.

2. **Sparse PCA Results:**

   | PC   | Strong Positive Correlations                                    | Strong Negative Correlations                                         |
   | ---- | --------------------------------------------------------------- | -------------------------------------------------------------------- |
   | PC1  | XLI (0.946), XLB (0.879), DIA (0.874), XLF (0.819), IWM (0.806) | VXX (-0.590)                                                         |
   | PC2  | XLU (0.909)                                                     | XLK (-0.158), VXX (-0.131)                                           |
   | PC3  | XLE (0.944), XLB (0.823)                                        | VXX (-0.416)                                                         |
   | PC4  | VXX (0.684)                                                     | SPY (-0.862), DIA (-0.835), XLC (-0.816), XLI (-0.807), XLY (-0.807) |
   | PC5  | XLRE (0.917), DIA (0.731), XLI (0.727), XLF (0.722)             | VXX (-0.444)                                                         |
   | PC6  | XLI (0.890), XLB (0.884), IWM (0.882), DIA (0.868)              | VXX (-0.570)                                                         |
   | PC7  | XLF (0.942), DIA (0.883), XLI (0.868), XLB (0.843)              | VXX (-0.525)                                                         |
   | PC8  | XLV (0.827), XLP (0.824), DIA (0.757), XLF (0.754)              | VXX (-0.338)                                                         |
   | PC9  | QQQ (0.938), XLK (0.918), SPY (0.910)                           | VXX (-0.728)                                                         |
   | PC10 | IWM (0.590), DIA (0.588), XLV (0.577), XLI (0.562)              | VXX (-0.406)                                                         |

   - PC1 in Sparse PCA mirrors the Full PCA results, confirming its role in capturing the broad bull market trend amidst global tensions.
   - PC2's strong correlation with utilities (XLU) and negative correlation with technology (XLK) might reflect a defensive positioning due to geopolitical uncertainties and anticipation of interest rate changes.
   - PC3's strong correlation with energy (XLE) and materials (XLB) likely captures the impact of the Ukraine war, sanctions on Russia, and the evolving BRICS dynamics on commodity markets.
   - PC4's relationship with volatility (VXX) and negative correlations with broad market ETFs might reflect market reactions to both Fed policy changes and escalating conflicts in the Middle East.

These results expand upon the sector-based analysis findings, now contextualized within the current economic and geopolitical environment:

- The strong performance of industrials and materials aligns with increased defense spending and global supply chain realignments.
- The varied correlations across different sectors reflect complex market dynamics as the economy navigates high interest rates, geopolitical tensions, and potential de-dollarization efforts by BRICS nations.
- The consistent negative correlation with volatility across several PCs is intriguing, given the numerous global risk factors, and may suggest a degree of complacency in the market.

### Implications

1. **Market Dynamics**: The strong correlations between the first few PCs and broad market ETFs confirm the resilience of the bull market despite significant global challenges. However, the distinct sector correlations in later PCs suggest nuanced market responses to changing economic conditions, monetary policy, and geopolitical events.

2. **Sector Rotation**: The varying correlations across PCs, particularly in Sparse PCA, highlight potential sector rotation strategies as the market adapts to the evolving interest rate environment and global tensions. The strong performance of utilities in PC2, for instance, might indicate a shift towards defensive sectors in anticipation of economic or geopolitical shocks.

3. **Risk Management**: While the negative correlations with VXX suggest overall low volatility, the presence of a volatility-correlated component (PC4 in Sparse PCA) indicates the importance of monitoring potential market stress, especially given the complex global situation. The apparent low volatility despite numerous risk factors warrants careful consideration in risk management strategies.

4. **Factor Investing**: The results suggest that PCA and Sparse PCA can effectively identify underlying factors in the market that respond to both broad economic trends and specific geopolitical events. This could inform more dynamic factor-based investment strategies that adapt to rapidly changing global conditions.

5. **Economic Indicators**: The strong correlations with sector-specific ETFs provide insights into how different sectors respond to economic cycles, policy changes, and global events. For example, the energy and materials correlations in PC3 could be particularly informative about the impact of geopolitical tensions and potential shifts in global trade dynamics.

### Conclusion and Transition to Dynamic Analysis

Through this correlation analysis, I've bridged the gap between statistical components derived from stock returns and broader market factors represented by ETFs, set against the backdrop of a prolonged bull market, significant monetary policy actions, and major geopolitical events.

My analysis has revealed several key insights:

1. The first principal component in both Full and Sparse PCA captures the broad bull market trend, with strong correlations to industrial, large-cap, and materials ETFs, reflecting both economic expansion and geopolitical influences.
2. Subsequent components, particularly in Sparse PCA, reflect nuanced market dynamics, including potential sector rotations, responses to interest rate changes, and reactions to global events such as the Ukraine war and Middle East conflicts.
3. The generally negative correlation of PCs with the volatility ETF (VXX) confirms overall market stability, which is surprising given the numerous global risk factors and warrants further investigation.

These findings offer valuable insights for both academic research and practical investment applications, particularly in understanding market behavior during periods of economic expansion, monetary policy shifts, and significant geopolitical tensions.

However, my analysis so far has been static, looking at the entire period from August 8 to September 19, 2024, as a whole. Given the significant events during this timeframe, including the Fed's rate cut and escalating global tensions, a dynamic analysis becomes crucial. To capture these evolving patterns and potential regime shifts, I will next employ a Rolling Window PCA approach.

In the following section, I will execute rolling PCA with a 10-day window to observe how these relationships change throughout my study period. This dynamic analysis will allow me to track changes in explained variance and loadings over time, potentially revealing how the market adapted to the sudden rate cut on September 18, 2024, and reacted to ongoing geopolitical developments. By applying this technique to both standard PCA and Sparse PCA, I aim to gain a more nuanced understanding of how market dynamics evolved in response to these significant economic and political events, and how different sectors and factors contributed to these changes over shorter time frames.

## Rolling Window PCA

While the full-period PCA and Sparse PCA analyses provide valuable insights into the overall market structure during the study period, they don't capture the dynamic nature of financial markets. To address this limitation and identify potential regime shifts or evolving market dynamics, I implemented a Rolling Window PCA approach. This method allows for a more granular examination of how principal components and their relationships with market sectors change over time.

### Methodology

I applied both standard PCA and Sparse PCA using a rolling window approach with the following parameters:

1. **Window Size**: 10 trading days
2. **Step Size**: 1 trading day
3. **Number of Components**: 10 (consistent with the full-period analysis)

For each window, I performed the following steps:

1. Extracted the data for the current 10-day window.
2. Applied standard PCA and Sparse PCA to this subset of data.
3. Calculated sector loadings for each principal component.
4. Computed market stability and deviation from the full-period analysis.

### Stability and Deviation Metrics

To quantify the changes in market structure over time, I introduced two key metrics:

1. **Market Stability**: This metric measures the similarity between consecutive time windows. I calculated it using the cosine similarity between the sector loadings of adjacent windows. A higher value indicates greater stability (less change) between windows, while a lower value suggests more significant shifts in market structure.

   Mathematically, for two consecutive windows $i$ and $i+1$, the stability is calculated as:

   $$\mathrm{Stability}_{i, i+1} = 1 - \mathrm{cosine\_distance}(\mathrm{loadings}_i, \mathrm{loadings}_{i+1})$$

   where $\mathrm{loadings}$ are the flattened arrays of sector loadings across all components.

2. **Deviation from Full Period**: This metric quantifies how much each rolling window's market structure deviates from the full-period analysis. It's calculated as the cosine similarity between the sector loadings of each rolling window and the full-period sector loadings. A higher value indicates that the window's market structure is more similar to the full-period structure, while a lower value suggests a greater deviation.

   For each window $i$, the deviation is calculated as:

   $$\mathrm{Deviation}_i = 1 - \mathrm{cosine\_distance}(\mathrm{loadings}_i, \mathrm{loadings}_{\mathrm{full}})$$

   where $\mathrm{loadings}_{\mathrm{full}}$ are the sector loadings from the full-period analysis.

These metrics provide insights into the evolving nature of market dynamics and help identify periods of significant change or stability.

### Interactive Dashboard

To visualize the results of the rolling window analysis comprehensively, I created an interactive dashboard using Plotly. This dashboard includes:

1. Full PCA Sector Loadings Heatmap
2. Sparse PCA Sector Loadings Heatmap
3. Market Stability Plot
4. Full Period Deviation Plot

The dashboard features a slider that allows for easy navigation through different time windows, providing a dynamic view of how market structure evolves over the study period.

<div class="l-page">
  <iframe src="{{ '/assets/plotly/RegimeShift/interactive_dashboard.html' | relative_url }}" frameborder='0' scrolling='no' height="700px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Interactive Dashboard for Rolling Window PCA Analysis. The slider at the bottom allows navigation through different time windows. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/rolling_window_analysis/interactive_dashboard.html">Kal Parvanov/GitHub</a>
</div>

### Results and Interpretation

#### Rolling Window PCA and Sparse PCA

The rolling window analysis revealed several interesting patterns and shifts in market dynamics over the study period:

1. **Sector Dominance Shifts**: In the early windows (August 23 to August 28), Financial Services consistently appeared as a dominant sector across multiple principal components in both Full PCA and Sparse PCA. However, this dominance waned in later windows, giving way to a more diverse representation of sectors.

2. **Energy Sector Prominence**: The Energy sector showed persistent importance, particularly in PC2 of both Full PCA and Sparse PCA, from September 4 onwards. This could be related to ongoing geopolitical tensions and their impact on global energy markets.

3. **Industrials Sector Consistency**: The Industrials sector maintained a consistent presence, especially in PC3 of both PCA methods, suggesting its steady influence on market movements throughout the period.

4. **Emergence of Consumer Sector**: Towards the latter half of the study period (from September 11 onwards), the Consumer sector began to feature more prominently, particularly in Sparse PCA results. This could indicate shifting market focus towards consumer behavior and spending patterns.

5. **Utilities and Real Estate Fluctuations**: These sectors showed intermittent significance, potentially reflecting changing investor sentiments about defensive stocks and interest rate expectations.

#### Market Stability Analysis

The Market Stability plot revealed several key insights:

1. **Overall Trend**: The market showed relatively high stability throughout the period, with most values above 0.8, indicating consistent market structures.

2. **Periods of Instability**: Notable drops in stability occurred on August 30 (0.771), September 12 (0.771), and September 19 (0.763). These dates coincide with significant market events:

   - August 30: Likely market reaction to the approaching month-end and anticipation of September economic data.
   - September 12: Corresponded with the release of producer-price inflation data, which influenced market expectations about the Federal Reserve's actions [WSJ, Sept. 12, 2024](https://www.wsj.com/livecoverage/stock-market-today-dow-sp500-nasdaq-live-09-12-2024).
   - September 19: Immediate market response to the Federal Reserve's unexpected 50 basis point rate cut on September 18 [WSJ, Sept. 18, 2024](https://www.wsj.com/livecoverage/fed-interest-rate-cut-inflation-live-09-18-2024).

3. **Periods of High Stability**: The market showed peak stability on September 6 (0.972) and September 16 (0.972), suggesting periods of market consensus or reduced uncertainty.

#### Deviation from Full Period Analysis

The Deviation from Full Period plot provided additional insights:

1. **Overall Trend**: The deviation generally increased over time, indicating that market structures in later windows differed more from the full-period analysis than earlier windows.

2. **Significant Deviations**: The largest deviations occurred on September 13 (0.545), September 16 (0.541), and September 17 (0.593). These dates align with increased market speculation about the Federal Reserve's upcoming rate decision [WSJ, Sept. 13, 2024](https://www.wsj.com/livecoverage/stock-market-today-dow-sp500-nasdaq-live-09-13-2024).

3. **Period of Least Deviation**: The market structure was most similar to the full-period analysis on September 3 (0.847), possibly indicating a "typical" market state during this time.

### Implications and Insights

The rolling window approach provided valuable insights that were not apparent in the full-period analysis:

1. **Dynamic Sector Influences**: The analysis revealed how different sectors' influences on market movements evolved over time, reflecting changing economic conditions and investor sentiments.

2. **Sensitivity to Economic Events**: The stability and deviation metrics effectively captured market reactions to key economic events and policy decisions, particularly around the Federal Reserve's rate cut.

3. **Market Adaptation**: The increasing deviation from the full-period analysis over time suggests that market structures were adapting to new information and changing economic landscapes.

4. **Trading Strategy Implications**: The identification of periods with distinct market structures could inform the development of adaptive trading strategies that adjust to changing market dynamics.

5. **Risk Management**: Periods of low stability or high deviation from the full-period analysis might warrant increased caution in risk management practices.

This rolling window analysis has provided a nuanced view of market dynamics, capturing short-term shifts and reactions to economic events that were not visible in the full-period analysis. However, it's important to note that this approach is sensitive to window size selection and may not capture very short-term fluctuations.

In the next section I will examine intraday patterns, where I will attempt to explore how these broader market dynamics manifest within the trading day, potentially revealing additional layers of market behavior and investor decision-making processes.

## Intraday Pattern Analysis

While the previous analyses focused on daily and multi-day market dynamics, intraday patterns can reveal crucial short-term behaviors within a single trading day. These patterns are often influenced by factors such as market open and close effects, lunch hour trading lulls, and scheduled economic announcements. In this section, I delve into the intraday patterns of stock returns using Sparse PCA techniques to uncover how sector influences change throughout the trading day.

### Methodology

To analyze intraday patterns, I implemented the following approach:

1. **Data Segmentation**: The trading day was divided into 13 intraday periods, balancing granularity with statistical robustness. Each period $p$ is represented by a time interval:

   $$p_i = [t_i, t_{i+1}), \quad i = 1, 2, ..., 13$$

   where $t_1$ corresponds to market open (9:30 AM) and $t_{14}$ to market close (4:00 PM).

2. **Sparse PCA Application**: For each intraday period $p_i$, Sparse PCA was applied with 10 components:

   $$X_{p_i} = US^T + E$$

   where $X_{p_i}$ is the data matrix for period $p_i$, $U$ are the sparse loadings, $S$ are the components, and $E$ is the error term.

3. **Sector Loading Calculation**: For each component $j$ and sector $S$ in period $p_i$, the sector loading $SL_{S,j,p_i}$ was calculated as:

   $$SL_{S,j,p_i} = \sum_{k \in S} \max(L_{k,j,p_i}, 0)$$

   where $L_{k,j,p_i}$ is the loading of stock $k$ in component $j$ for period $p_i$. These were then normalized across sectors:

   $$NSL_{S,j,p_i} = \frac{SL_{S,j,p_i}}{\sum_{S'} SL_{S',j,p_i}}$$

4. **Visualization**: Two main visualizations were created:

   - An intraday heatmap showing $NSL_{S,j,p_i}$ for all sectors, components, and periods.
   - A sector influence plot demonstrating the average sector influence:

     $$ASI_{S,p_i} = \frac{\sum_{j=1}^{10} NSL_{S,j,p_i}}{\sum_{S'} \sum_{j=1}^{10} NSL_{S',j,p_i}}$$

This approach allows for a comprehensive examination of intraday market dynamics, potentially revealing patterns not visible in daily or weekly analyses.

### Results and Interpretation

The intraday pattern analysis yielded two key visualizations that provide insights into how sector influences change throughout the trading day.

#### Intraday Patterns Heatmap

The first visualization is a heatmap showing the intraday patterns of sector influence on Sparse PCA components:

<div class="l-page">
  <iframe src="{{ '/assets/plotly/RegimeShift/intraday_patterns_heatmap.html' | relative_url }}" frameborder='0' scrolling='yes' height="800px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Heatmap of Intraday Patterns: Sector Influence on Sparse PCA Components. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/interpretation_results/intraday_patterns_heatmap.html">Kal Parvanov/GitHub</a>
</div>

The intraday patterns heatmap reveals several interesting trends in sector influence across different periods of the trading day:

1. **Sector Dominance Variability**: Different sectors dominate various principal components (PCs) throughout the day. For instance, Financial Services dominates PC1 at market open (09:30-10:00) but shifts to PC7 by mid-morning (10:30-11:00).

2. **Technology Sector Influence**: Technology shows strong influence in early trading, particularly in PC2 (09:30-10:00) and PC3 (10:00-10:30), but its dominance becomes more sporadic as the day progresses.

3. **Energy Sector Consistency**: The Energy sector consistently influences PC3 throughout most of the day, suggesting a stable pattern in energy-related market movements.

4. **Utilities Sector Pattern**: Utilities frequently dominate PC5 or PC6, especially in the middle of the trading day, indicating a consistent role in explaining market variance during these periods.

5. **Consumer Sector Variability**: The Consumer sector shows high variability, dominating different PCs at different times, which might reflect changing consumer behavior or market sentiment throughout the day.

6. **End-of-Day Shifts**: In the final trading period (15:30-16:00), there's a noticeable shift in sector influences, with Technology regaining prominence in PC2 and Financial Services becoming more influential in PC3 and PC8.

These patterns suggest that the market's underlying structure, as captured by the principal components, evolves throughout the trading day, with different sectors playing varying roles in explaining market variance at different times.

#### Sector Influence Changes

The second visualization is a line plot showing how sector influences change throughout the trading day:

<div class="l-page">
  <iframe src="{{ '/assets/plotly/RegimeShift/sector_influence_changes.html' | relative_url }}" frameborder='0' scrolling='no' height="600px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>
<div class="caption">
    Changes in Sector Influence Throughout the Trading Day. Plot credit: <a href="https://github.com/parvanovkp/RegimeShift/blob/main/interpretation_results/sector_influence_changes.html">Kal Parvanov/GitHub</a>
</div>

The sector influence changes plot provides a comprehensive view of how each sector's overall influence evolves throughout the trading day:

1. **Consumer Sector Volatility**: The Consumer sector shows the highest volatility in influence, with a notable spike (32.54%) during the 11:00-11:30 period, possibly reflecting increased trading activity around consumer-related news or data releases.

2. **Technology Sector Trend**: Technology starts the day with high influence (16.19% at open) but generally decreases throughout the day before rising again in the final period (15.37% at close).

3. **Financial Services Fluctuations**: Financial Services shows significant fluctuations, with peaks in the early afternoon (14.72% at 13:30-14:00) and late afternoon (20.39% at 15:00-15:30), possibly aligning with key economic announcements or end-of-day portfolio adjustments.

4. **Energy Sector Stability**: The Energy sector maintains a relatively stable influence throughout the day, ranging between 4.79% and 8.76%, suggesting consistent trading patterns.

5. **Utilities Sector Pattern**: Utilities show increased influence in the early afternoon, peaking at 18.15% during 14:00-14:30, which could be related to daily energy consumption patterns or specific market events.

6. **Communication Services Spikes**: Communication Services experiences notable spikes in influence, particularly during the 11:00-11:30 and 13:30-14:00 periods, possibly reflecting sector-specific news or trading patterns.

### Key Intraday Patterns Observed

1. **Opening and Closing Effects**: Many sectors show distinct patterns at market open and close. For example, Technology and Consumer sectors have higher influence at the start and end of the trading day.

2. **Midday Shifts**: Several sectors experience significant changes in influence during the middle of the trading day, particularly around the 11:00-11:30 and 14:00-14:30 periods. This could be related to lunch hour effects or the timing of economic announcements.

3. **Sector Rotations**: There are observable "rotations" in sector influence throughout the day. As one sector's influence decreases, another often increases, suggesting a dynamic reallocation of trading focus.

4. **Persistent Components**: Some sectors, like Energy and Utilities, show persistent influence on specific principal components throughout the day, indicating stable underlying factors in these sectors.

5. **Afternoon Volatility**: The period from 14:00 to market close shows increased volatility in sector influences, potentially reflecting heightened trading activity as market participants position themselves before the close.

These patterns provide valuable insights into the intraday dynamics of the stock market, revealing how different sectors drive market movements at various times of the day. However, it's important to note that these patterns are based on averaged data over the study period and may not reflect day-to-day variations or responses to specific events.

### Implications

The intraday pattern analysis provides valuable insights into stock market behavior within a trading day. Key implications include:

1. **Trading Strategies**:

   - Energy sector's consistent influence on PC3 could inform sector rotation strategies.
   - Consumer sector's high volatility, especially around 11:00-11:30, might offer short-term trading opportunities.
   - Technology sector's changing influence throughout the day could guide entry and exit points for tech-focused trades.

2. **Risk Management**:

   - Increased afternoon volatility, particularly from 14:00 onwards, suggests a need for tighter risk controls during these periods.
   - Stable sectors like Utilities could potentially hedge against more volatile sector movements.

3. **Market Microstructure**:

   - Consistent patterns in certain sectors might indicate regular algorithmic trading activities.
   - Spikes in sector influence could reflect high-frequency trading strategies' impact.

4. **Liquidity Provision**:

   - Afternoon volatility in sector influences might require liquidity providers to adjust spreads and inventory levels.
   - Consistent influence of sectors like Energy could inform stable liquidity provision strategies for related stocks.

5. **Portfolio Rebalancing**:
   - Observed sector rotations and end-of-day shifts could guide optimal times for portfolio rebalancing, potentially minimizing market impact.

### Limitations and Future Work

While this analysis provides valuable insights, it's important to acknowledge its limitations:

1. **Time Period Specificity**: The patterns observed are specific to the analyzed time period (August to September 2024) and may not generalize to other market conditions or time frames. Market dynamics can vary significantly across different periods due to changing economic conditions, geopolitical events, or structural changes in the market.

2. **Granularity Trade-off**: The choice of 13 intraday periods balances detail with statistical robustness, but different granularities might reveal additional patterns. The current segmentation might miss very short-term fluctuations or smooth over rapid changes in sector influences.

3. **Market Events**: The analysis doesn't explicitly account for scheduled market events which could significantly impact intraday patterns. Major economic announcements, earnings releases, or other news events could drive some of the observed patterns.

4. **Aggregation Effects**: By aggregating data across multiple trading days, this analysis may obscure day-specific patterns or anomalies that could be significant for certain trading strategies.

5. **Sector Classification**: The sector classifications used in this analysis are based on standard categorizations, which may not always capture the nuanced relationships between companies or subsectors.

Future work could address these limitations and extend the analysis in several ways:

- Extending the analysis to cover longer time periods and different market regimes, allowing for the identification of more stable intraday patterns and their evolution over time.
- Incorporating external data sources, such as news sentiment, economic calendars, or order flow data, to contextualize intraday patterns and potentially explain anomalies.
- Conducting a more granular analysis of subsectors or individual stocks within sectors to identify potential leaders or laggards in intraday pattern formation.
- Developing and backtesting trading strategies based on the observed intraday patterns to assess their practical applicability and robustness.
- Analyzing the impact of different time zone markets (e.g., European or Asian markets) on the observed patterns in the U.S. market.

This granular approach to market analysis has the potential to refine trading strategies, improve risk management practices, and deepen one's understanding of the complex, ever-changing nature of financial markets. By addressing these limitations and pursuing these avenues for future research, one can continue to enhance one's understanding of intraday market dynamics and their implications for various market participants.

## Conclusion: Key Findings and Future Research Directions

This comprehensive analysis of S&P 500 stocks using PCA and Sparse PCA techniques has yielded several significant insights into market dynamics and sector behaviors:

1. The full-period PCA revealed that capturing 80% of market variance required 154 components, highlighting the complexity of market dynamics.
2. Sparse PCA effectively isolated key sector influences, with Technology, Consumer, and Financial Services sectors frequently emerging as dominant factors.
3. The correlation analysis with ETF factors demonstrated strong relationships between principal components and sector-specific ETFs, providing a bridge between statistical findings and real-world market factors.
4. Rolling window PCA uncovered evolving market structures, particularly around significant events like the Federal Reserve's rate cut in September 2024.
5. Intraday pattern analysis revealed distinct sector behaviors at different times of the trading day, such as the Consumer sector's high volatility and the Energy sector's consistent influence.

These findings have several practical implications:

- For portfolio management, the identified sector influences and their temporal variations can inform more dynamic asset allocation strategies.
- Risk assessment models can be enhanced by incorporating the changing market structures revealed through rolling window analysis.
- Traders can leverage the intraday patterns to optimize entry and exit points for sector-specific trades.

While this analysis provides valuable insights, there are several avenues for future research:

1. Expanding the dataset to cover longer time periods and different market regimes to test the stability of observed patterns.
2. Incorporating alternative data sources, such as news sentiment or order flow data, to provide additional context to market movements.
3. Applying advanced machine learning techniques, such as deep learning models, to capture more complex, non-linear relationships in the data.

By pursuing these research directions, it is possible to further refine the understanding of market dynamics, potentially leading to more robust investment strategies and risk management practices. This project contributes to the field of quantitative finance and demonstrates the efficacy of dimensionality reduction techniques in uncovering hidden structures within complex financial systems such as the stock market.

## Appendix

**Project Code:** [Kal Parvanov/Github](https://github.com/parvanovkp/RegimeShift)
